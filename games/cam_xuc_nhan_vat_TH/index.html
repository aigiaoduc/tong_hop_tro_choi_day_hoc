<!doctype html>
<html lang="vi">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tr√≤ Ch∆°i Nh·∫≠n Di·ªán C·∫£m X√∫c</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-x: hidden;
    }

    *, *::before, *::after {
      box-sizing: inherit;
    }

    .game-container {
      width: 90%;
      max-width: 900px;
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      margin: 40px auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .game-title {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .score-display {
      font-size: 20px;
      color: #764ba2;
      font-weight: 600;
    }

    .story-section {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      border-left: 6px solid #667eea;
    }

    .story-text {
      font-size: 18px;
      line-height: 1.8;
      color: #2d3748;
      margin: 0;
    }

    .character-display {
      text-align: center;
      margin: 40px 0;
      position: relative;
    }

    .character {
      font-size: 120px;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: inline-block;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
    }

    .character.celebrate {
      animation: celebrate 0.6s ease-in-out;
    }

    .character.shake {
      animation: shake 0.5s ease-in-out;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.3) rotate(-10deg); }
      50% { transform: scale(1.3) rotate(10deg); }
      75% { transform: scale(1.3) rotate(-10deg); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-15px); }
      75% { transform: translateX(15px); }
    }

    .particle {
      position: absolute;
      pointer-events: none;
      animation: float-up 1.5s ease-out forwards;
    }

    @keyframes float-up {
      0% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-100px) scale(0.5);
      }
    }

    .emotions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .emotion-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 20px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .emotion-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .emotion-btn:active {
      transform: translateY(-2px);
    }

    .emotion-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .feedback {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      border: 3px solid;
      display: none;
      animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .feedback.show {
      display: block;
    }

    .feedback.correct {
      border-color: #48bb78;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    }

    .feedback.incorrect {
      border-color: #f56565;
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    }

    .feedback-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .feedback.correct .feedback-title {
      color: #48bb78;
    }

    .feedback.incorrect .feedback-title {
      color: #f56565;
    }

    .feedback-text {
      font-size: 16px;
      line-height: 1.6;
      color: #2d3748;
    }

    .next-btn {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: block;
      margin: 20px auto 0;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    .next-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
    }

    .game-complete {
      text-align: center;
      display: none;
    }

    .game-complete.show {
      display: block;
    }

    .complete-emoji {
      font-size: 100px;
      margin: 20px 0;
      animation: celebrate 1s ease-in-out infinite;
    }

    .complete-title {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
    }

    .final-score {
      font-size: 28px;
      color: #764ba2;
      font-weight: 600;
      margin-bottom: 30px;
    }

    .leaderboard {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 16px;
      padding: 25px;
      margin-top: 30px;
      max-height: 300px;
      overflow-y: auto;
    }

    .leaderboard-title {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 20px;
      text-align: center;
    }

    .leaderboard-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .leaderboard-rank {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      margin-right: 15px;
    }

    .leaderboard-name {
      flex: 1;
      font-size: 18px;
      color: #2d3748;
    }

    .leaderboard-score {
      font-size: 18px;
      font-weight: 600;
      color: #764ba2;
    }

    .restart-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .restart-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .name-input-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .name-input {
      padding: 12px 20px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 15px;
    }

    .start-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .question-count-btn {
      padding: 12px 30px;
      border: 3px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .question-count-btn:hover {
      transform: translateY(-2px);
    }

    .question-count-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .loading {
      text-align: center;
      color: #667eea;
      font-size: 18px;
      margin: 20px 0;
      display: none;
    }

    .loading.show {
      display: block;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="game-container">
   <div class="header">
    <div class="game-title" id="gameTitle">
     üé≠ Tr√≤ Ch∆°i Nh·∫≠n Di·ªán C·∫£m X√∫c
    </div>
    <div class="score-display" id="scoreDisplay">
     ƒêi·ªÉm: 0 / 0
    </div>
   </div>
   <div class="name-input-section" id="nameInputSection">
    <h2 style="color: #667eea; margin-bottom: 20px;">Nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu!</h2><input type="text" id="nameInput" class="name-input" placeholder="T√™n c·ªßa b·∫°n..."> <br>
    <div style="margin: 20px 0;"><label style="font-size: 18px; color: #667eea; font-weight: 600; display: block; margin-bottom: 10px;">Ch·ªçn s·ªë l∆∞·ª£ng c√¢u h·ªèi:</label>
     <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;"><button class="question-count-btn" data-count="5">5 c√¢u</button> <button class="question-count-btn active" data-count="10">10 c√¢u</button> <button class="question-count-btn" data-count="15">15 c√¢u</button>
     </div>
    </div><button class="start-btn" id="startBtn">B·∫Øt ƒë·∫ßu ch∆°i</button>
   </div>
   <div id="gameContent" style="display: none;">
    <div class="story-section">
     <p class="story-text" id="storyText"></p>
    </div>
    <div class="character-display">
     <div class="character" id="character">
      üòê
     </div>
    </div>
    <div class="emotions-grid" id="emotionsGrid"><button class="emotion-btn" data-emotion="vui" data-emoji="üòä">üòä Vui</button> <button class="emotion-btn" data-emotion="buon" data-emoji="üò¢">üò¢ Bu·ªìn</button> <button class="emotion-btn" data-emotion="lolang" data-emoji="üò∞">üò∞ Lo l·∫Øng</button> <button class="emotion-btn" data-emotion="tucgian" data-emoji="üò†">üò† T·ª©c gi·∫≠n</button> <button class="emotion-btn" data-emotion="hivong" data-emoji="üåü">üåü Hi v·ªçng</button> <button class="emotion-btn" data-emotion="ngacnhien" data-emoji="üò≤">üò≤ Ng·∫°c nhi√™n</button>
    </div>
    <div class="feedback" id="feedback">
     <div class="feedback-title" id="feedbackTitle"></div>
     <div class="feedback-text" id="feedbackText"></div><button class="next-btn" id="nextBtn">C√¢u ti·∫øp theo ‚Üí</button>
    </div>
   </div>
   <div class="game-complete" id="gameComplete">
    <div class="complete-emoji">
     üéâ
    </div>
    <div class="complete-title">
     Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh!
    </div>
    <div class="final-score" id="finalScore"></div><button class="restart-btn" id="restartBtn">Ch∆°i l·∫°i</button>
    <div class="leaderboard" id="leaderboard">
     <div class="leaderboard-title">
      üèÜ B·∫£ng X·∫øp H·∫°ng
     </div>
     <div id="leaderboardList"></div>
    </div>
   </div>
   <div class="loading" id="loading">
    ƒêang t·∫£i...
   </div>
  </div>
  <script>
    const defaultConfig = {
      game_title: "üé≠ Tr√≤ Ch∆°i Nh·∫≠n Di·ªán C·∫£m X√∫c",
      story_excerpt: "B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c ƒëi·ªÉm 10 m√¥n To√°n. B·∫°n ch·∫°y v·ªÅ nh√† v√† k·ªÉ cho ba m·∫π nghe. Ba m·∫π khen ng·ª£i v√† √¥m b·∫°n th·∫≠t ch·∫∑t.",
      hint_text: "H√£y ƒë·ªçc l·∫°i t√¨nh hu·ªëng v√† ch√∫ √Ω ƒë·∫øn chi ti·∫øt!",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#2d3748",
      primary_action_color: "#667eea",
      secondary_action_color: "#48bb78",
      font_family: "Segoe UI",
      font_size: 16
    };

    let currentConfig = { ...defaultConfig };
    let currentRecordCount = 0;

    const allQuestions = [
      {
        story: "B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c ƒëi·ªÉm 10 m√¥n To√°n. B·∫°n ch·∫°y v·ªÅ nh√† v√† k·ªÉ cho ba m·∫π nghe. Ba m·∫π khen ng·ª£i v√† √¥m b·∫°n th·∫≠t ch·∫∑t.",
        correctEmotion: "vui",
        correctEmoji: "üòä",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c vui m·ª´ng khi ƒë∆∞·ª£c ba m·∫π khen ng·ª£i v√¨ h·ªçc t·ªët."
      },
      {
        story: "B·∫°n th√¢n c·ªßa b·∫°n ph·∫£i chuy·ªÉn tr∆∞·ªùng sang t·ªânh kh√°c. Ng√†y cu·ªëi c√πng, hai b·∫°n √¥m nhau v√† n√≥i l·ªùi t·∫°m bi·ªát.",
        correctEmotion: "buon",
        correctEmoji: "üò¢",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c bu·ªìn khi ph·∫£i chia tay ng∆∞·ªùi b·∫°n th√¢n."
      },
      {
        story: "Mai l√† ng√†y thi h·ªçc k·ª≥. B·∫°n v·∫´n ch∆∞a √¥n xong b√†i. ƒê√™m khuya b·∫°n v·∫´n c√≤n th·ª©c ƒë·ªÉ h·ªçc nh∆∞ng c√†ng h·ªçc c√†ng th·∫•y nhi·ªÅu.",
        correctEmotion: "lolang",
        correctEmoji: "üò∞",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c lo l·∫Øng khi ch∆∞a chu·∫©n b·ªã k·ªπ cho k·ª≥ thi."
      },
      {
        story: "B·∫°n m·∫•t chi·∫øc ƒëi·ªán tho·∫°i m·ªõi mua ƒë∆∞·ª£c 1 tu·∫ßn. B·∫°n t√¨m kh·∫Øp n∆°i nh∆∞ng kh√¥ng th·∫•y. B·∫°n nghi ng·ªù c√≥ ng∆∞·ªùi ƒë√£ l·∫•y tr·ªôm.",
        correctEmotion: "tucgian",
        correctEmoji: "üò†",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c t·ª©c gi·∫≠n khi m·∫•t ƒë·ªì v√† nghi c√≥ ng∆∞·ªùi l·∫•y tr·ªôm."
      },
      {
        story: "B·∫°n b·ªã ·ªëm n·∫∑ng v√† ph·∫£i ngh·ªâ h·ªçc 2 tu·∫ßn. Gi·ªù b·∫°n ƒë√£ kh·ªèe h∆°n v√† chu·∫©n b·ªã ƒëi h·ªçc l·∫°i. B·∫°n mong ƒë∆∞·ª£c g·∫∑p l·∫°i b·∫°n b√®.",
        correctEmotion: "hivong",
        correctEmoji: "üåü",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c hy v·ªçng v√† mong ch·ªù ƒë∆∞·ª£c tr·ªü l·∫°i tr∆∞·ªùng."
      },
      {
        story: "B·∫°n ƒëang ƒëi ƒë∆∞·ªùng th√¨ b·ªóng nhi√™n c√≥ ng∆∞·ªùi g·ªçi to t√™n b·∫°n. Quay l·∫°i b·∫°n th·∫•y ƒë√≥ l√† ng∆∞·ªùi b·∫°n c≈© m√† b·∫°n ƒë√£ l√¢u kh√¥ng g·∫∑p.",
        correctEmotion: "ngacnhien",
        correctEmoji: "üò≤",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c ng·∫°c nhi√™n khi g·∫∑p l·∫°i ng∆∞·ªùi b·∫°n c≈© b·∫•t ng·ªù."
      },
      {
        story: "B·∫°n c·ªë g·∫Øng luy·ªán t·∫≠p ƒë·ªÉ v√†o ƒë·ªôi tuy·ªÉn b√≥ng ƒë√° c·ªßa tr∆∞·ªùng. H√¥m nay th·∫ßy gi√°o c√¥ng b·ªë danh s√°ch v√† b·∫°n th·∫•y t√™n m√¨nh trong ƒë√≥.",
        correctEmotion: "vui",
        correctEmoji: "üòä",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c vui m·ª´ng khi n·ªó l·ª±c c·ªßa b·∫°n ƒë∆∞·ª£c ƒë·ªÅn ƒë√°p."
      },
      {
        story: "Ba b·∫°n h·ª©a s·∫Ω ƒë∆∞a b·∫°n ƒëi xem phim cu·ªëi tu·∫ßn. Nh∆∞ng ƒë·∫øn t·ªëi th·ª© b·∫£y, ba n√≥i c√¥ng vi·ªác b·∫≠n kh√¥ng ƒëi ƒë∆∞·ª£c v√† h·ª©a s·∫Ω ƒëi tu·∫ßn sau.",
        correctEmotion: "buon",
        correctEmoji: "üò¢",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c bu·ªìn khi k·∫ø ho·∫°ch mong ƒë·ª£i b·ªã h·ªßy b·ªè."
      },
      {
        story: "B·∫°n l√†m v·ª° chi·∫øc b√¨nh hoa qu√Ω c·ªßa m·∫π. B·∫°n kh√¥ng bi·∫øt n√™n n√≥i th·∫≠t hay gi·∫•u ƒëi. B·∫°n ƒë·ª©ng nh√¨n m·∫£nh v·ª° v√† kh√¥ng bi·∫øt ph·∫£i l√†m sao.",
        correctEmotion: "lolang",
        correctEmoji: "üò∞",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c lo l·∫Øng khi g√¢y ra l·ªói l·∫ßm v√† s·ª£ b·ªã la m·∫Øng."
      },
      {
        story: "B·∫°n l√†m b√†i t·∫≠p nh√≥m r·∫•t c·ªë g·∫Øng. Nh∆∞ng m·ªôt b·∫°n trong nh√≥m kh√¥ng l√†m g√¨ c·∫£ m√† v·∫´n ƒë∆∞·ª£c ƒëi·ªÉm cao nh∆∞ b·∫°n.",
        correctEmotion: "tucgian",
        correctEmoji: "üò†",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c t·ª©c gi·∫≠n khi c·∫£m th·∫•y b·∫•t c√¥ng."
      },
      {
        story: "B·∫°n tham gia cu·ªôc thi v·∫Ω c·∫•p th√†nh ph·ªë. D√π ch∆∞a bi·∫øt k·∫øt qu·∫£ nh∆∞ng b·∫°n tin v√†o b·ª©c tranh c·ªßa m√¨nh v√† mong ch·ªù ng√†y c√¥ng b·ªë.",
        correctEmotion: "hivong",
        correctEmoji: "üåü",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c hy v·ªçng v√† t·ª± tin v√†o kh·∫£ nƒÉng c·ªßa b·∫£n th√¢n."
      },
      {
        story: "Gi·ªØa gi·ªù h·ªçc, c√¥ gi√°o b·∫•t ng·ªù th√¥ng b√°o ng√†y mai c·∫£ l·ªõp s·∫Ω ƒëi d√£ ngo·∫°i. C·∫£ l·ªõp v·ªó tay reo h√≤.",
        correctEmotion: "ngacnhien",
        correctEmoji: "üò≤",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c ng·∫°c nhi√™n th√∫ v·ªã khi c√≥ tin vui b·∫•t ng·ªù."
      },
      {
        story: "B·∫°n tr·ªìng c√¢y d∆∞a h·∫•u trong v∆∞·ªùn. Sau 3 th√°ng chƒÉm s√≥c, h√¥m nay b·∫°n thu ho·∫°ch ƒë∆∞·ª£c 5 qu·∫£ d∆∞a to tr√≤n.",
        correctEmotion: "vui",
        correctEmoji: "üòä",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c vui m·ª´ng khi th·∫•y k·∫øt qu·∫£ t·ª´ s·ª± chƒÉm s√≥c c·ªßa m√¨nh."
      },
      {
        story: "Con m√®o m√† b·∫°n nu√¥i t·ª´ nh·ªè ƒë√£ m·∫•t t√≠ch 3 ng√†y nay. B·∫°n ƒëi t√¨m kh·∫Øp n∆°i nh∆∞ng v·∫´n kh√¥ng th·∫•y.",
        correctEmotion: "buon",
        correctEmoji: "üò¢",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c bu·ªìn khi m·∫•t ƒëi th√∫ c∆∞ng y√™u qu√Ω."
      },
      {
        story: "B·∫°n ƒë∆∞·ª£c ch·ªçn l√†m ƒë·∫°i di·ªán l·ªõp ph√°t bi·ªÉu tr∆∞·ªõc to√†n tr∆∞·ªùng. ƒê√¢y l√† l·∫ßn ƒë·∫ßu ti√™n b·∫°n n√≥i tr∆∞·ªõc nhi·ªÅu ng∆∞·ªùi nh∆∞ v·∫≠y.",
        correctEmotion: "lolang",
        correctEmoji: "üò∞",
        explanation: "ƒê√¢y l√† c·∫£m x√∫c lo l·∫Øng khi ph·∫£i ƒë·ªëi di·ªán v·ªõi t√¨nh hu·ªëng m·ªõi v√† √°p l·ª±c."
      }
    ];
    
    let questions = [];
    let selectedQuestionCount = 10;

    let currentQuestion = 0;
    let score = 0;
    let studentName = "";
    let gameStarted = false;

    const dataHandler = {
      onDataChanged(data) {
        currentRecordCount = data.length;
        renderLeaderboard(data);
      }
    };

    async function initializeApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to initialize data SDK");
      }
    }

    function renderLeaderboard(data) {
      const leaderboardList = document.getElementById('leaderboardList');
      if (!leaderboardList) return;

      const completedGames = data
        .filter(record => record.completed)
        .sort((a, b) => {
          const percentA = (a.score / a.total_questions) * 100;
          const percentB = (b.score / b.total_questions) * 100;
          return percentB - percentA;
        })
        .slice(0, 10);

      if (completedGames.length === 0) {
        leaderboardList.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o</div>';
        return;
      }

      leaderboardList.innerHTML = completedGames.map((record, index) => {
        const percentage = Math.round((record.score / record.total_questions) * 100);
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
        return `
          <div class="leaderboard-item">
            <span class="leaderboard-rank">${medal} #${index + 1}</span>
            <span class="leaderboard-name">${record.student_name}</span>
            <span class="leaderboard-score">${record.score}/${record.total_questions} (${percentage}%)</span>
          </div>
        `;
      }).join('');
    }

    async function onConfigChange(config) {
      currentConfig = config;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
      
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.primary_action_color || defaultConfig.primary_action_color} 100%)`;
      
      const gameTitle = document.getElementById('gameTitle');
      if (gameTitle) {
        gameTitle.textContent = config.game_title || defaultConfig.game_title;
        gameTitle.style.fontSize = `${baseSize * 2.25}px`;
        gameTitle.style.color = config.primary_action_color || defaultConfig.primary_action_color;
      }
      
      const storyText = document.getElementById('storyText');
      if (storyText && gameStarted) {
        storyText.textContent = config.story_excerpt || defaultConfig.story_excerpt;
        storyText.style.fontSize = `${baseSize * 1.125}px`;
        storyText.style.color = config.text_color || defaultConfig.text_color;
      }
      
      const emotionBtns = document.querySelectorAll('.emotion-btn');
      emotionBtns.forEach(btn => {
        btn.style.background = `linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
        btn.style.fontSize = `${baseSize * 1.125}px`;
      });
      
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn) {
        nextBtn.style.background = `linear-gradient(135deg, ${config.secondary_action_color || defaultConfig.secondary_action_color} 0%, ${config.primary_action_color || defaultConfig.primary_action_color} 100%)`;
        nextBtn.style.fontSize = `${baseSize * 1.125}px`;
      }
      
      const startBtn = document.getElementById('startBtn');
      if (startBtn) {
        startBtn.style.background = `linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
        startBtn.style.fontSize = `${baseSize * 1.125}px`;
      }
      
      const restartBtn = document.getElementById('restartBtn');
      if (restartBtn) {
        restartBtn.style.background = `linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
        restartBtn.style.fontSize = `${baseSize * 1.125}px`;
      }
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_action_color || defaultConfig.primary_action_color,
              set: (value) => {
                config.primary_action_color = value;
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            },
            {
              get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
              set: (value) => {
                config.secondary_action_color = value;
                window.elementSdk.setConfig({ secondary_action_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["game_title", config.game_title || defaultConfig.game_title],
          ["story_excerpt", config.story_excerpt || defaultConfig.story_excerpt],
          ["hint_text", config.hint_text || defaultConfig.hint_text]
        ])
      });
    }

    function updateScore() {
      const scoreDisplay = document.getElementById('scoreDisplay');
      scoreDisplay.textContent = `ƒêi·ªÉm: ${score} / ${currentQuestion}`;
    }

    function createParticles(emoji) {
      const characterDisplay = document.querySelector('.character-display');
      for (let i = 0; i < 10; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.textContent = emoji;
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = '50%';
        particle.style.fontSize = `${20 + Math.random() * 30}px`;
        characterDisplay.appendChild(particle);
        
        setTimeout(() => particle.remove(), 1500);
      }
    }

    function showFeedback(isCorrect, explanation) {
      const feedback = document.getElementById('feedback');
      const feedbackTitle = document.getElementById('feedbackTitle');
      const feedbackText = document.getElementById('feedbackText');
      
      feedback.className = 'feedback show ' + (isCorrect ? 'correct' : 'incorrect');
      feedbackTitle.textContent = isCorrect ? '‚úÖ Ch√≠nh x√°c!' : '‚ùå Ch∆∞a ƒë√∫ng';
      feedbackText.textContent = isCorrect ? explanation : currentConfig.hint_text || defaultConfig.hint_text;
    }

    function loadQuestion() {
      const question = questions[currentQuestion];
      const storyText = document.getElementById('storyText');
      const character = document.getElementById('character');
      const feedback = document.getElementById('feedback');
      
      storyText.textContent = question.story;
      character.textContent = 'üòê';
      character.className = 'character';
      feedback.classList.remove('show');
      
      const emotionBtns = document.querySelectorAll('.emotion-btn');
      emotionBtns.forEach(btn => btn.disabled = false);
    }

    async function completeGame() {
      const loading = document.getElementById('loading');
      loading.classList.add('show');
      
      if (currentRecordCount >= 999) {
        loading.classList.remove('show');
        const gameContent = document.getElementById('gameContent');
        const gameComplete = document.getElementById('gameComplete');
        const finalScore = document.getElementById('finalScore');
        
        gameContent.style.display = 'none';
        gameComplete.classList.add('show');
        
        const percentage = Math.round((score / questions.length) * 100);
        finalScore.textContent = `B·∫°n ƒë·∫°t ${score}/${questions.length} c√¢u ƒë√∫ng (${percentage}%)`;
        
        const toastMessage = document.createElement('div');
        toastMessage.textContent = 'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 k·∫øt qu·∫£. Kh√¥ng th·ªÉ l∆∞u th√™m.';
        toastMessage.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #f56565; color: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; font-size: 16px;';
        document.body.appendChild(toastMessage);
        setTimeout(() => toastMessage.remove(), 3000);
        
        loading.classList.remove('show');
        return;
      }
      
      const result = await window.dataSdk.create({
        student_name: studentName,
        score: score,
        total_questions: questions.length,
        timestamp: new Date().toISOString(),
        completed: true
      });
      
      loading.classList.remove('show');
      
      if (result.isOk) {
        const gameContent = document.getElementById('gameContent');
        const gameComplete = document.getElementById('gameComplete');
        const finalScore = document.getElementById('finalScore');
        
        gameContent.style.display = 'none';
        gameComplete.classList.add('show');
        
        const percentage = Math.round((score / questions.length) * 100);
        finalScore.textContent = `B·∫°n ƒë·∫°t ${score}/${questions.length} c√¢u ƒë√∫ng (${percentage}%)`;
      } else {
        const toastMessage = document.createElement('div');
        toastMessage.textContent = 'C√≥ l·ªói khi l∆∞u k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.';
        toastMessage.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #f56565; color: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; font-size: 16px;';
        document.body.appendChild(toastMessage);
        setTimeout(() => toastMessage.remove(), 3000);
      }
    }

    document.querySelectorAll('.question-count-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.question-count-btn').forEach(b => {
          b.classList.remove('active');
        });
        btn.classList.add('active');
        selectedQuestionCount = parseInt(btn.dataset.count);
      });
    });

    document.getElementById('startBtn').addEventListener('click', () => {
      const nameInput = document.getElementById('nameInput');
      studentName = nameInput.value.trim();
      
      if (!studentName) {
        const toastMessage = document.createElement('div');
        toastMessage.textContent = 'Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!';
        toastMessage.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #f56565; color: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; font-size: 16px;';
        document.body.appendChild(toastMessage);
        setTimeout(() => toastMessage.remove(), 2000);
        return;
      }
      
      // Tr√°o ng·∫´u nhi√™n t·∫•t c·∫£ c√¢u h·ªèi
      const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
      questions = shuffled.slice(0, selectedQuestionCount);
      
      gameStarted = true;
      document.getElementById('nameInputSection').style.display = 'none';
      document.getElementById('gameContent').style.display = 'block';
      loadQuestion();
    });

    document.getElementById('emotionsGrid').addEventListener('click', (e) => {
      const btn = e.target.closest('.emotion-btn');
      if (!btn || btn.disabled) return;
      
      const emotionBtns = document.querySelectorAll('.emotion-btn');
      emotionBtns.forEach(b => b.disabled = true);
      
      const selectedEmotion = btn.dataset.emotion;
      const selectedEmoji = btn.dataset.emoji;
      const question = questions[currentQuestion];
      const character = document.getElementById('character');
      
      character.textContent = selectedEmoji;
      
      const isCorrect = selectedEmotion === question.correctEmotion;
      
      if (isCorrect) {
        score++;
        character.classList.add('celebrate');
        createParticles('‚ú®');
        showFeedback(true, question.explanation);
      } else {
        character.classList.add('shake');
        showFeedback(false, '');
      }
      
      updateScore();
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      currentQuestion++;
      
      if (currentQuestion >= questions.length) {
        completeGame();
      } else {
        loadQuestion();
      }
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      currentQuestion = 0;
      score = 0;
      gameStarted = false;
      studentName = "";
      questions = [];
      
      document.getElementById('gameComplete').classList.remove('show');
      document.getElementById('nameInputSection').style.display = 'block';
      document.getElementById('nameInput').value = '';
      
      document.querySelectorAll('.question-count-btn').forEach((btn, index) => {
        if (index === 1) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      selectedQuestionCount = 10;
      
      updateScore();
    });

    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a0ab69ed488ce75',t:'MTc2MzUwMjk0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>